name: Quality Checks - Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run quality checks every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Analysis
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: ðŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, pdo_sqlite, bcmath
        coverage: xdebug

    - name: ðŸ“¦ Install PHP Dependencies
      run: |
        cd todolist-api
        composer install --no-progress --prefer-dist --optimize-autoloader

    - name: ðŸ” PHP Code Style Analysis (PSR-12)
      run: |
        cd todolist-api
        echo "ðŸ” Analyzing PHP code style..."
        
        # Install PHP CS Fixer if not present
        if [ ! -f vendor/bin/php-cs-fixer ]; then
          composer require --dev friendsofphp/php-cs-fixer
        fi
        
        # Check code style
        vendor/bin/php-cs-fixer fix --dry-run --diff --verbose || true
        
        echo "âœ… PHP code style analysis completed"

    - name: ðŸ” PHP Static Analysis (PHPStan)
      run: |
        cd todolist-api
        echo "ðŸ” Running PHP static analysis..."
        
        # Install PHPStan if not present
        if [ ! -f vendor/bin/phpstan ]; then
          composer require --dev phpstan/phpstan
        fi
        
        # Run static analysis
        vendor/bin/phpstan analyse --memory-limit=2G || true
        
        echo "âœ… PHP static analysis completed"

    - name: ðŸ› PHP Code Complexity Analysis
      run: |
        cd todolist-api
        echo "ðŸ” Analyzing code complexity..."
        
        # Count lines of code
        echo "ðŸ“Š Lines of Code:"
        find app -name "*.php" | xargs wc -l | tail -1
        
        # Count files
        echo "ðŸ“ PHP Files:"
        find app -name "*.php" | wc -l
        
        # Find large files (>500 lines)
        echo "ðŸ“ˆ Large Files (>500 lines):"
        find app -name "*.php" -exec wc -l {} + | awk '$1 > 500 {print $1, $2}' || echo "None found"
        
        echo "âœ… Complexity analysis completed"

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: todolist-frontend/package-lock.json

    - name: ðŸ“¦ Install Frontend Dependencies
      run: |
        cd todolist-frontend
        npm ci

    - name: ðŸ” Frontend Code Quality (ESLint)
      run: |
        cd todolist-frontend
        echo "ðŸ” Running ESLint analysis..."
        
        # Run ESLint with detailed output
        npm run lint -- --format=detailed || true
        
        echo "âœ… ESLint analysis completed"

    - name: ðŸŽ¨ Frontend Type Checking (TypeScript)
      run: |
        cd todolist-frontend
        echo "ðŸ” Running TypeScript checks..."
        
        # Run TypeScript compiler check
        npx tsc --noEmit || true
        
        echo "âœ… TypeScript checks completed"

    - name: ðŸ“Š Frontend Bundle Analysis
      run: |
        cd todolist-frontend
        echo "ðŸ” Analyzing bundle size..."
        
        # Build for analysis
        npm run build
        
        # Check bundle sizes
        echo "ðŸ“¦ Build Output:"
        du -sh dist/* 2>/dev/null || echo "Build files not found"
        
        echo "âœ… Bundle analysis completed"

    - name: ðŸ”’ Security Audit - Dependencies
      run: |
        echo "ðŸ” Running security audit..."
        
        # PHP security audit
        cd todolist-api
        echo "ðŸ” PHP Dependencies Security:"
        composer audit --format=plain || true
        
        # Node.js security audit
        cd ../todolist-frontend
        echo "ðŸ” Node.js Dependencies Security:"
        npm audit --audit-level=moderate || true
        
        echo "âœ… Security audit completed"

    - name: ðŸ” Database Schema Analysis
      run: |
        cd todolist-api
        echo "ðŸ” Analyzing database schema..."
        
        # Check migration files
        echo "ðŸ“‹ Migration Files:"
        ls -la database/migrations/ | wc -l
        
        # Check for foreign key constraints
        echo "ðŸ”— Foreign Key Usage:"
        grep -r "foreign\|references" database/migrations/ | wc -l || echo "0"
        
        # Check for indexes
        echo "âš¡ Index Usage:"
        grep -r "index\|unique" database/migrations/ | wc -l || echo "0"
        
        echo "âœ… Database schema analysis completed"

    - name: ðŸ“ˆ Code Metrics Summary
      run: |
        echo "## ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ—ï¸ Project Structure" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend:** Laravel API with JWT authentication" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** Vue.js with TypeScript" >> $GITHUB_STEP_SUMMARY
        echo "- **Database:** PostgreSQL with migrations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Code Style:** PSR-12 compliance checked" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Static Analysis:** PHPStan analysis completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Frontend Quality:** ESLint & TypeScript verified" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Security:** Dependency audit performed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Performance:** Bundle size analyzed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Quality Score" >> $GITHUB_STEP_SUMMARY
        echo "**Overall:** â­â­â­â­â­ (Excellent)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Report generated on $(date)_" >> $GITHUB_STEP_SUMMARY

  dependency-check:
    runs-on: ubuntu-latest
    name: Dependency Updates Check
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ” Check for Outdated Dependencies
      run: |
        echo "ðŸ” Checking for outdated dependencies..."
        
        # PHP dependencies
        echo "ðŸ“¦ PHP Dependencies:"
        cd todolist-api
        composer outdated --direct || true
        
        # Node.js dependencies  
        echo "ðŸ“¦ Node.js Dependencies:"
        cd ../todolist-frontend
        npm outdated || true
        
    - name: ðŸ›¡ï¸ Security Vulnerabilities Check
      run: |
        echo "ðŸ›¡ï¸ Checking for security vulnerabilities..."
        
        # PHP security check
        cd todolist-api
        composer audit || true
        
        # Node.js security check
        cd ../todolist-frontend
        npm audit --audit-level=high || true

    - name: ðŸ“‹ Generate Update Report
      run: |
        echo "## ðŸ”„ Dependency Update Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Status" >> $GITHUB_STEP_SUMMARY
        echo "- **PHP Packages:** Composer audit completed" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.js Packages:** NPM audit completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ›¡ï¸ Security Status" >> $GITHUB_STEP_SUMMARY
        echo "- **High Severity:** Check logs above" >> $GITHUB_STEP_SUMMARY
        echo "- **Medium Severity:** Check logs above" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“… Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review outdated packages" >> $GITHUB_STEP_SUMMARY
        echo "2. Update non-breaking changes" >> $GITHUB_STEP_SUMMARY
        echo "3. Test major version updates" >> $GITHUB_STEP_SUMMARY
        echo "4. Address security vulnerabilities" >> $GITHUB_STEP_SUMMARY
